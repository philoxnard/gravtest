
Gravity JSON Application Programmer Interface
=============================================

The Gravity Framework is designed with a built in API that both browsers use to interact with the server over POST requests, but third-party clients can also interact with the system as well though the same interface and message format.

The Gravity API allows both protected and unprotected to pass through the interface. The word protected in this context means that the command is only allowed to be processed if the user has logged in and the messaged is being
passed with an authenticated "token" that has been generated by the server.

The user must first login to the server using a username and password, assuming the authentication passes, the response will include a "token" object.  This token object should be placed at the root level of any future interactions with the server assuming we wish to execute commands that are protected.

The protected command list is stored in the MessageParser.py file currently. If you are adding any new commands
to Gravity and the command should be protected, then you need to add the command to this list.

# TODO: Add command that gets all of the protected commands, note this itself should be a protected command.

Interacting with the Gravity API
--------------------------------

There are a couple ways currently to interact with the API, both through AJAX POST requests and through a Websocket connection. Future implementations of Gravity will also let you interact with the API through a raw socket connection.

This project includes sample code inside of the client/python folder. You can use this sample code to bootstrap any client programs you need to interact and test the API.

Interact with API Through the Gravity Client Python Code
--------------------------------------------------------

To test the python code that is included with this project, you may need to make some modifications to the client/python/GravityAjaxApi.py file until this project is more mature.

Inside of this file, there are several test functions you can use to test your code. This currently only works with HTTP, so when you start the server, you should disable the HTTPS server with the "--disable" command to use this code for now.

If you place the contactAdd function in the main program at the bottom of the file, you will see how it adds a contact to the list. You can try other test functions inside of the class by adjusting the main function.  You will also need to adjust the self.url variable if you are trying to interact with Gravity running on a server other than localhost.

	$ cd client/python
	# python GravityAjaxApi.py

Take note of the "login()" function inside of this class. If you are interacting with the API over a protected function, you must call this function with the proper username and password to login before you can execute any protected commands. If you don't do this, the API will reject the command and say the token is missing or invalid.

Interact with the API Through Curl
----------------------------------

Another way to interact with the API is through curl. With this program, it is possible to interact with the server also using HTTPS, follow the instructions below.

### Curl Sample Request ###

curl is a command line program that can submit HTTP/HTTPS requests.  With this program, we can send a POST request containing a JSON command to the Gravity Server.  In these examples, we assume that the server is configured to interact through localhost (or 127.0.0.1), but you could do this across a network by providing the IP address of the host.

HTTP
	$ curl -k -H "Content-Type: application/json" -X POST -d '{"command": "ajax_test", "value": "TEST123"}' http://localhost/login

The response to this login will be something that looks like the following:

	{"output": "Gravity Server Received Input: TEST123", "command": "ajax_test", "msg_type": "reply"}


### Registering through the API

Before you can login to the Gravity server, you must have an account on the system. If you have not yet created
an account, you can register for an account through the Gravity API.

	$ curl -H "Content-Type: application/json" -X POST -d '{"command": "register", "user_info" : { "name": "Patrick Farrell", "username" : "test@test.com", "password" : "password", "password_confirm" : "password" }}' http://localhost/api

You will receive a message back which will contain a JSON Web Token.  You can use this token to access the API.
However if you then logout, you will need to log back in with the instructions in the next section.

	$ curl -H "Content-Type: application/json" -X POST -d '{"command": "register", "user_info" : { "name": "Patrick Farrell", "username" : "test@test.com", "password" : "password", "password_confirm" : "password" }}' http://localhost/api


### Logging in

When you wish to access the Gravity API, you must login first for any messages and services that require authentication.

The first step before you can actually send any information to the Gravity Server is you must authenticate with the server and obtain a JSON Web token (JWT).  We usually just call the JWT a token in this documentation and code. 

You do this by sending a POST request to the server.  You must use the "-k" option to turn off the certificate verification because we are not using a certificate signed by a Certificate Authority (CA).

	$ curl -H "Content-Type: application/json" -X POST -d '{"command": "login", "user_login_info" : { "username" : "test@test.com", "password" : "password" }}' http://localhost/login

The response to this login will be something that looks like the following:

	{"token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1NTk1MTg0MDEsIm5iZiI6MTU1OTUxODQwMSwiZXhwIjoxNTYyMTEwNDAxLCJhdWQiOiIxIn0.PofQODINVZJ2q9-dW0Bhq11yIfBMeKFS9J1RA2RrSVI", "command": "login", "msg_type": "reply"}

You must now store this token and submit on future requests to the server.  It must be submitted in the header but you can submit it in a cookie or as a Bearer token.  When using the API, it is suggested that you submit the token as a Bearer token.

	$ curl -H "Content-Type: application/json" -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1NTk1MTg0MDEsIm5iZiI6MTU1OTUxODQwMSwiZXhwIjoxNTYyMTEwNDAxLCJhdWQiOiIxIn0.PofQODINVZJ2q9-dW0Bhq11yIfBMeKFS9J1RA2RrSVI" -X POST -d '{"msg_type":"request","command":"ajax_test","value":"TEST"}' http://localhost

You may submit multiple requests with the same token.  While it is not required to logout, it is good practice after you have finished. Use the following command to logout.

	$ curl -H "Content-Type: application/json" -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1MjMwNDM5ODUsIm5iZiI6MTUyMzA0Mzk4NSwiZXhwIjoxNTI1NjM1OTg1LCJhdWQiOiIxIn0.66y7TrQebuROy3AWaejwJ5KdCALJm6phYQ4QhXV3ltc" -X POST -d '{"command": "logout"}' http://localhost
